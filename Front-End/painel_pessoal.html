<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Portal do Aluno</title>
    <link rel="stylesheet" href="painel_pessoal.css">
  </head>
  <body>
    <div class="container">
      <div class="header">
        <label for="fotoInput">
          <img
            id="fotoAluno"
            src="https://cdn-icons-png.flaticon.com/512/847/847969.png"
            alt="Foto do Aluno"
          />
        </label>
        <input
          type="file"
          id="fotoInput"
          accept="image/*"
          style="display: none"
        />

        <h2 id="nomeHeader">Nome do Aluno</h2>
      </div>

      <div class="tabs">
        <div class="tab active" onclick="showTab('dados')">DADOS PESSOAIS</div>
        <div class="tab" onclick="showTab('banca')">MINHA BANCA</div>
        <div class="tab" onclick="showTab('notas')">VISUALIZAR NOTAS</div>
        <div class="tab" onclick="showTab('alertas')">VISUALIZAR ALERTAS</div>
        <div class="tab" onclick="showTab('reunioes')">MINHAS REUNIÕES</div>
        <div class="tab" onclick="showTab('upload')">UPLOAD</div>
      </div>

      <div id="dados" class="tab-content active">
        <div class="dados-lista">
          <p><strong>Nome:</strong> <span id="nomeAluno"></span></p>
          <p>
            <strong>Data de Nascimento:</strong>
            <span id="dataNascimento"></span>
          </p>
          <p><strong>Contato:</strong> <span id="contato"></span></p>
          <p><strong>CPF:</strong> <span id="cpf"></span></p>
          <p><strong>RG:</strong> <span id="rg"></span></p>
          <p><strong>Cidade:</strong> <span id="cidade"></span></p>
          <p><strong>Endereço:</strong> <span id="endereco"></span></p>
          <p><strong>Estado Civil:</strong> <span id="estadoCivil"></span></p>
          <p><strong>Sexo:</strong> <span id="sexo"></span></p>
          <p><strong>Nome do Pai:</strong> <span id="nomePai"></span></p>
          <p><strong>Nome da Mãe:</strong> <span id="nomeMae"></span></p>
        </div>
      </div>

      <div id="banca" class="tab-content">
        <div id="banca-info"></div>
      </div>

      <div id="notas" class="tab-content">
        <h3>Minhas Notas e Avaliações</h3>
        <div id="notas-info">
          <p>Carregando suas notas...</p>
          </div>
      </div>

      <div id="alertas" class="tab-content">
        <p>Os alertas aparecerão aqui...</p>
      </div>

      <div id="reunioes" class="tab-content">
        <h3>Minhas Reuniões</h3>
        <ul id="listaReunioesAluno"></ul>
      </div>

      <div id="upload" class="tab-content">
        <input type="file" />
      </div>

      <div id="cronograma" class="tab-content">
        <p>O cronograma aparecerá aqui...</p>
      </div>
    </div>

    <script>
      function showTab(tabId) {
          document.querySelectorAll(".tab-content").forEach((tab) => tab.classList.remove("active"));
          document.querySelectorAll(".tab").forEach((tab) => tab.classList.remove("active"));
          document.getElementById(tabId).classList.add("active");
          document.querySelector(`[onclick="showTab('${tabId}')"]`).classList.add("active");

          if (tabId === 'banca') {
              loadBanca();
          }

          if (tabId === 'notas') {
            loadNotas();
        }

        if (tabId === 'reunioes') {
            loadReunioesAluno();
        }
      }

      const fotoInput = document.getElementById("fotoInput");
      const fotoAluno = document.getElementById("fotoAluno");

      fotoInput.addEventListener("change", function () {
          const file = this.files[0];
          if (file) {
              const reader = new FileReader();
              reader.onload = function (e) {
                  fotoAluno.src = e.target.result;
              };
              reader.readAsDataURL(file);
          }
      });

      let todosProfessores = [];

      window.addEventListener("DOMContentLoaded", async () => {
          const usuario = JSON.parse(localStorage.getItem("usuarioLogado"));

          if (!usuario) {
              alert("Usuário não logado!");
              window.location.href = "login.html";
              return;
          }

          document.getElementById("nomeHeader").textContent = usuario.nome;
          document.getElementById("nomeAluno").textContent = usuario.nome;
          document.getElementById("dataNascimento").textContent = usuario.data_nascimento;
          document.getElementById("contato").textContent = usuario.contato;
          document.getElementById("cpf").textContent = usuario.cpf;
          document.getElementById("rg").textContent = usuario.rg;
          document.getElementById("cidade").textContent = usuario.cidade;
          document.getElementById("endereco").textContent = usuario.endereco;
          document.getElementById("estadoCivil").textContent = usuario.estado_civil;
          document.getElementById("sexo").textContent = usuario.sexo;
          document.getElementById("nomePai").textContent = usuario.nome_pai;
          document.getElementById("nomeMae").textContent = usuario.nome_mae;

          if (usuario.foto) {
              document.getElementById("fotoAluno").src = usuario.foto;
          }

          await loadAllProfessores();
      });

      async function loadAllProfessores() {
        try {
            const response = await fetch("http://localhost:3000/api/professores");
            todosProfessores = await response.json();
        } catch (error) {
            console.error("Erro ao carregar todos os professores:", error);
        }
    }

      function getProfessorNameById(id) {
          const prof = todosProfessores.find(p => p.id == id);
          return prof ? prof.nome : 'Professor não encontrado';
      }

      let bancaProfessores = {};

  async function loadBanca() {
    const bancaInfo = document.getElementById('banca-info');
    bancaInfo.innerHTML = '';

    const usuario = JSON.parse(localStorage.getItem("usuarioLogado"));
    if (!usuario) {
        bancaInfo.innerHTML = '<p class="aviso-banca">Usuário não logado. Faça o login para ver a banca.</p>';
        return;
    }

    try {
        const response = await fetch(`http://localhost:3000/api/bancas/${usuario.id}`);
        const banca = await response.json();

        if (response.ok) {
            const prof1Nome = getProfessorNameById(banca.professor1_id);
            const prof2Nome = getProfessorNameById(banca.professor2_id);
            const prof3Nome = getProfessorNameById(banca.professor3_id);

            const professoresBanca = [
                { nome: prof1Nome, funcao: 'Professor(a) 1' },
                { nome: prof2Nome, funcao: 'Professor(a) 2' },
                { nome: prof3Nome, funcao: 'Orientador(a)' } 
            ];

            professoresBanca.forEach(professor => {
                const li = document.createElement('li');
                li.innerHTML = `<strong>${professor.funcao}:</strong> ${professor.nome}`;
                bancaInfo.appendChild(li);
            });
        } else {
            const aviso = document.createElement('p');
            aviso.textContent = banca.error;
            aviso.classList.add('aviso-banca');
            bancaInfo.appendChild(aviso);
        }
    } catch (error) {
        console.error("Erro ao carregar a banca:", error);
        const aviso = document.createElement('p');
        aviso.textContent = 'Erro ao carregar a banca. Tente novamente mais tarde.';
        aviso.classList.add('aviso-banca');
        bancaInfo.appendChild(aviso);
    }
}

          async function loadNotas() {
          const notasInfo = document.getElementById('notas-info');
          notasInfo.innerHTML = '<p>Buscando notas...</p>';
        
          const usuario = JSON.parse(localStorage.getItem("usuarioLogado"));
        
          if (!usuario || !usuario.id) {
              notasInfo.innerHTML = '<p class="aviso-banca">Usuário não logado ou ID não encontrado.</p>';
              return;
          }
        
          try {
              const response = await fetch(`http://localhost:3000/api/notas/${usuario.id}`);
          
              if (!response.ok) {
                  notasInfo.innerHTML = '<p class="aviso-banca">Não foi possível carregar as notas. Tente novamente.</p>';
                  return;
              }

              const notas = await response.json();
          
              if (notas && notas.length > 0) {
                  const notasAgrupadas = notas.reduce((acc, nota) => {
                      const [criterioPrincipal] = nota.criterio.split('_');
                      if (!acc[criterioPrincipal]) {
                          acc[criterioPrincipal] = [];
                      }
                      acc[criterioPrincipal].push(nota);
                      return acc;
                  }, {});

                  let htmlContent = '<h4>Avaliações Detalhadas:</h4>';

                  for (const criterio in notasAgrupadas) {
                      const notasDoCriterio = notasAgrupadas[criterio];

                      const nomeCriterio = {
                          'proposta': 'Proposta',
                          'reelaboracao': 'Reelaboração',
                          'tc': 'Trabalho de Conclusão'
                      }[criterio] || criterio;

                      htmlContent += `<div class="avaliacao-container">`;
                      htmlContent += `<h5>${nomeCriterio}</h5>`;
                      
                      const notasPorProfessor = notasDoCriterio.reduce((acc, nota) => {
                          if (!acc[nota.professor_nome]) {
                              acc[nota.professor_nome] = [];
                          }
                          acc[nota.professor_nome].push(nota);
                          return acc;
                      }, {});

                      for (const professor in notasPorProfessor) {
                          htmlContent += `<h6>Professor(a) ${professor}</h6>`;
                          htmlContent += `<ul>`;
                          
                          notasPorProfessor[professor].forEach(nota => {
                              const nomeSubCriterio = nota.criterio.split('_').slice(1).join(' ').replace(/\b\w/g, l => l.toUpperCase());
                              htmlContent += `<li><strong>${nomeSubCriterio}:</strong> ${nota.nota} (Lançada em: ${new Date(nota.data_lancamento).toLocaleDateString()})</li>`;
                          });
                          htmlContent += `</ul>`;
                      }

                      htmlContent += `</div>`;
                  }

                  notasInfo.innerHTML = htmlContent;
              } else {
                  notasInfo.innerHTML = '<p class="aviso-banca">Nenhuma nota foi lançada ainda.</p>';
              }
          } catch (error) {
              console.error("Erro ao carregar as notas:", error);
              notasInfo.innerHTML = '<p class="aviso-banca">Erro ao carregar notas. Verifique a conexão com o servidor.</p>';
          }
      }

      async function loadReunioesAluno() {
        const usuario = JSON.parse(localStorage.getItem("usuarioLogado"));

        try {
          const response = await fetch(`http://localhost:3000/api/reunioes/aluno/${usuario.id}`);
          const reunioes = await response.json();

          const lista = document.getElementById("listaReunioesAluno");
          lista.innerHTML = "";

          reunioes.forEach(r => {
            const li = document.createElement("li");
            li.innerHTML = `<strong>${r.data} ${r.hora}</strong> - Professor: ${r.professor_nome} (${r.descricao || "Sem descrição"})`;
            lista.appendChild(li);
          });
        } catch (error) {
          console.error("Erro ao carregar reuniões:", error);
        }
      }

      if (tabId === 'reunioes') {
        loadReunioesAluno();
      }
    </script>
  </body>
</html>
